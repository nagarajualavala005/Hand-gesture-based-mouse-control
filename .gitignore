 import cv2
import mediapipe as mp
import pyautogui
import numpy as np
import time

mp_hands = mp.solutions.hands
mp_drawing = mp.solutions.drawing_utils
screen_width, screen_height = pyautogui.size()
cap = cv2.VideoCapture(0)

cv2.namedWindow('Hand Gesture Mouse', cv2.WINDOW_NORMAL)
cv2.resizeWindow('Hand Gesture Mouse', 900, 700)

def get_dist(p1, p2):
    return np.hypot(p1[0]-p2[0], p1[1]-p2[1])

click_buffer = []
drag_mode = False
click_time = 0
last_palm_y = None
SCROLL_SENS = 35  # Higher for less sensitivity, lower for more

with mp_hands.Hands(max_num_hands=1, min_detection_confidence=0.7, min_tracking_confidence=0.7) as hands:
    while True:
        ret, frame = cap.read()
        if not ret:
            break
        frame = cv2.flip(frame, 1)
        h, w, _ = frame.shape
        rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        results = hands.process(rgb)

        command = "Tracking"
        gesture = None

        if results.multi_hand_landmarks:
            for hand_landmarks in results.multi_hand_landmarks:
                mp_drawing.draw_landmarks(frame, hand_landmarks, mp_hands.HAND_CONNECTIONS)
                lm = hand_landmarks.landmark
                pts = [(int(l.x * w), int(l.y * h)) for l in lm]

                index_tip, thumb_tip = pts[8], pts[4]
                middle_tip = pts[12]
                screen_x = np.interp(index_tip[0], [0, w], [0, screen_width])
                screen_y = np.interp(index_tip[1], [0, h], [0, screen_height])
                pyautogui.moveTo(screen_x, screen_y, duration=0)
                cv2.circle(frame, index_tip, 11, (0,255,0), -1)
                cv2.circle(frame, thumb_tip, 11, (255,0,0), -1)
                cv2.circle(frame, middle_tip, 11, (0,255,255), -1)

                # Left click: index-thumb pinch
                dist_it_tt = get_dist(index_tip, thumb_tip)
                if dist_it_tt < 38:
                    gesture = "Click!"
                    if time.time()-click_time > 0.7:
                        pyautogui.click()
                        click_time = time.time()
                        command = gesture
                        print(command)

                # Right click: middle-thumb pinch
                dist_mt_tt = get_dist(middle_tip, thumb_tip)
                if dist_mt_tt < 38:
                    gesture = "Right-Click!"
                    pyautogui.rightClick()
                    command = gesture
                    print(command)

                # Drag/select: index-middle pinch
                dist_it_mt = get_dist(index_tip, middle_tip)
                if dist_it_mt < 38:
                    gesture = "Drag/Select"
                    if not drag_mode:
                        pyautogui.mouseDown()
                        drag_mode = True
                        command = gesture
                        print(command)
                else:
                    if drag_mode:
                        pyautogui.mouseUp()
                        drag_mode = False

                # Double click: quick repeated index-thumb pinch
                click_buffer.append(1 if dist_it_tt < 38 else 0)
                if len(click_buffer) > 18:
                    click_buffer.pop(0)
                if sum(click_buffer) > 15:
                    gesture = "Double Click!"
                    pyautogui.doubleClick()
                    command = gesture
                    print(command)
                    click_buffer = [0]*18

                # Palm-center for scroll (use wrist: pts[0])
                open_hand = (
                    get_dist(pts[5], pts[8]) > 45 and
                    get_dist(pts[9], pts[12]) > 45 and
                    get_dist(pts[13], pts[16]) > 45 and
                    get_dist(pts[17], pts[20]) > 45
                )
                palm_y = pts[0][1]
                if open_hand:
                    if last_palm_y is not None:
                        # Negative value: moved up -> scroll up
                        if palm_y < last_palm_y - SCROLL_SENS:
                            gesture = "Scroll Up"
                            pyautogui.scroll(60)
                            command = gesture
                            print(command)
                        # Positive value: moved down -> scroll down
                        elif palm_y > last_palm_y + SCROLL_SENS:
                            gesture = "Scroll Down"
                            pyautogui.scroll(-60)
                            command = gesture
                            print(command)
                    last_palm_y = palm_y
                else:
                    last_palm_y = None

                # Neon bold overlay
                if gesture:
                    cv2.putText(frame, gesture, (index_tip[0], index_tip[1]-40),
                                cv2.FONT_HERSHEY_DUPLEX, 1.5, (0,255,255), 4)
                cv2.putText(frame, "built by: Team 2", (frame.shape[1]-320, frame.shape[0]-25),
                            cv2.FONT_HERSHEY_SIMPLEX, 0.9, (0,255,255), 2)

        else:
            drag_mode = False
            last_palm_y = None

        cv2.putText(frame, f"{command}", (35,60), cv2.FONT_HERSHEY_COMPLEX, 1.2, (255,0,255), 2)
        cv2.imshow('Hand Gesture Mouse', frame)
        if cv2.waitKey(1) == 27:
            break

cap.release()
cv2.destroyAllWindows()
